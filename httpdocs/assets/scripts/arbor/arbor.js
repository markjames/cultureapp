//
//  arbor.js - version 0.5
//  a graph vizualization toolkit
//
//  Copyright (c) 2011 Samizdat Drafting Co.
//  Physics code derived from springy.js, copyright (c) 2010 Dennis Hotson
// 
//  Permission is hereby granted, free of charge, to any person
//  obtaining a copy of this software and associated documentation
//  files (the "Software"), to deal in the Software without
//  restriction, including without limitation the rights to use,
//  copy, modify, merge, publish, distribute, sublicense, and/or sell
//  copies of the Software, and to permit persons to whom the
//  Software is furnished to do so, subject to the following
//  conditions:
// 
//  The above copyright notice and this permission notice shall be
//  included in all copies or substantial portions of the Software.
// 
//  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
//  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
//  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
//  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
//  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
//  WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
//  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
//  OTHER DEALINGS IN THE SOFTWARE.
//

(function($){

  /*      etc.js */  var trace=function(msg){if(typeof(window)=="undefined"||!window.console){return}var len=arguments.length;var args=[];for(var i=0;i<len;i++){args.push("arguments["+i+"]")}eval("console.log("+args.join(",")+")")};var dirname=function(a){var b=a.replace(/^\/?(.*?)\/?$/,"$1").split("/");b.pop();return"/"+b.join("/")};var basename=function(b){var c=b.replace(/^\/?(.*?)\/?$/,"$1").split("/");var a=c.pop();if(a==""){return null}else{return a}};var _ordinalize_re=/(\d)(?=(\d\d\d)+(?!\d))/g;var ordinalize=function(a){var b=""+a;if(a<11000){b=(""+a).replace(_ordinalize_re,"$1,")}else{if(a<1000000){b=Math.floor(a/1000)+"k"}else{if(a<1000000000){b=(""+Math.floor(a/1000)).replace(_ordinalize_re,"$1,")+"m"}}}return b};var nano=function(a,b){return a.replace(/\{([\w\-\.]*)}/g,function(f,c){var d=c.split("."),e=b[d.shift()];$.each(d,function(){if(e.hasOwnProperty(this)){e=e[this]}else{e=f}});return e})};var objcopy=function(a){if(a===undefined){return undefined}if(a===null){return null}if(a.parentNode){return a}switch(typeof a){case"string":return a.substring(0);break;case"number":return a+0;break;case"boolean":return a===true;break}var b=($.isArray(a))?[]:{};$.each(a,function(d,c){b[d]=objcopy(c)});return b};var objmerge=function(d,b){d=d||{};b=b||{};var c=objcopy(d);for(var a in b){c[a]=b[a]}return c};var objcmp=function(e,c,d){if(!e||!c){return e===c}if(typeof e!=typeof c){return false}if(typeof e!="object"){return e===c}else{if($.isArray(e)){if(!($.isArray(c))){return false}if(e.length!=c.length){return false}}else{var h=[];for(var f in e){if(e.hasOwnProperty(f)){h.push(f)}}var g=[];for(var f in c){if(c.hasOwnProperty(f)){g.push(f)}}if(!d){h.sort();g.sort()}if(h.join(",")!==g.join(",")){return false}}var i=true;$.each(e,function(a){var b=objcmp(e[a],c[a]);i=i&&b;if(!i){return false}});return i}};var objkeys=function(b){var a=[];$.each(b,function(d,c){if(b.hasOwnProperty(d)){a.push(d)}});return a};var objcontains=function(c){if(!c||typeof c!="object"){return false}for(var b=1,a=arguments.length;b<a;b++){if(c.hasOwnProperty(arguments[b])){return true}}return false};var uniq=function(b){var a=b.length;var d={};for(var c=0;c<a;c++){d[b[c]]=true}return objkeys(d)};var arbor_path=function(){var a=$("script").map(function(b){var c=$(this).attr("src");if(!c){return}if(c.match(/arbor[^\/\.]*.js|dev.js/)){return c.match(/.*\//)||"/"}});if(a.length>0){return a[0]}else{return null}};
  /*   kernel.js */  var Kernel=function(b){var a=(window.Worker!==undefined);var i=null;var c=null;var f=[];f.last=new Date();var k=null;var d=null;var e=null;var h=null;var g=false;var j={system:b,tween:null,nodes:{},init:function(){if(typeof(Tween)!="undefined"){c=Tween()}else{if(typeof(arbor.Tween)!="undefined"){c=arbor.Tween()}else{c={busy:function(){return false},tick:function(){return true},to:function(){trace("Please include arbor-tween.js to enable tweens");c.to=function(){};return}}}}j.tween=c;var l=b.parameters();if(a){trace("using web workers");k=setInterval(j.screenUpdate,l.timeout);i=new Worker(arbor_path()+"arbor.js");i.onmessage=j.workerMsg;i.onerror=function(m){trace("physics:",m)};i.postMessage({type:"physics",physics:objmerge(l,{timeout:Math.ceil(l.timeout*0.5)})})}else{trace("couldn't use web workers, be careful...");i=Physics(l.dt,l.stiffness,l.repulsion,l.friction,j.system._updateGeometry);j.start()}return j},graphChanged:function(l){if(a){i.postMessage({type:"changes",changes:l})}else{i._update(l)}j.start()},particleModified:function(m,l){if(a){i.postMessage({type:"modify",id:m,mods:l})}else{i.modifyNode(m,l)}j.start()},physicsModified:function(l){if(!isNaN(l.timeout)){if(a){clearInterval(k);k=setInterval(j.screenUpdate,l.timeout);l.timeout*=0.5}else{clearInterval(e);e=null}}if(a){i.postMessage({type:"sys",param:l})}else{i.modifyPhysics(l)}j.start()},workerMsg:function(m){var l=m.data.type;if(l=="geometry"){j.workerUpdate(m.data)}else{trace("physics:",m.data)}},_lastPositions:null,workerUpdate:function(l){j._lastPositions=l;j._lastBounds=l.bounds},_lastFrametime:new Date().valueOf(),_lastBounds:null,_currentRenderer:null,screenUpdate:function(){var m=new Date().valueOf();var l=false;if(j._lastPositions!==null){j.system._updateGeometry(j._lastPositions);j._lastPositions=null;l=true}if(c&&c.busy()){l=true}if(j.system._updateBounds(j._lastBounds)){l=true}if(l){var n=j.system.renderer;if(n!==undefined){if(n!==d){n.init(j.system);d=n}if(c){c.tick()}n.redraw();var o=f.last;f.last=new Date();f.push(f.last-o);if(f.length>50){f.shift()}}}},physicsUpdate:function(){if(c){c.tick()}i.tick();var m=j.system._updateBounds();if(c&&c.busy()){m=true}var n=j.system.renderer;var l=new Date();var n=j.system.renderer;if(n!==undefined){if(n!==d){n.init(j.system);d=n}n.redraw({timestamp:l})}var p=f.last;f.last=l;f.push(f.last-p);if(f.length>50){f.shift()}var o=i.systemEnergy();if(o.max<0.01&&!m){if(h===null){h=l.valueOf()}if(l.valueOf()-h>1000){trace("stopping");clearInterval(e);e=null}else{}}else{h=null}},fps:function(m){if(m!==undefined){var p=1000/Math.max(1,targetFps);j.physicsModified({timeout:p})}var q=0;for(var o=0,n=f.length;o<n;o++){q+=f[o]}var l=q/Math.max(1,f.length);if(!isNaN(l)){return Math.round(1000/l)}else{return 0}},start:function(l){if(e!==null){return}if(g&&!l){return}g=false;if(a){i.postMessage({type:"start"})}else{h=null;e=setInterval(j.physicsUpdate,j.system.parameters().timeout)}},stop:function(){g=true;if(a){i.postMessage({type:"stop"})}else{if(e!==null){clearInterval(e);e=null}}}};return j.init()};
  /*    atoms.js */  var Node=function(a){this._id=_nextNodeId++;this.data=a||{};this._mass=(a.mass!==undefined)?a.mass:1;this._fixed=(a.fixed===true)?true:false;this._p=new Point((typeof(a.x)=="number")?a.x:null,(typeof(a.y)=="number")?a.y:null);delete this.data.x;delete this.data.y;delete this.data.mass;delete this.data.fixed};var _nextNodeId=1;var Edge=function(b,c,a){this._id=_nextEdgeId--;this.source=b;this.target=c;this.length=(a.length!==undefined)?a.length:1;this.data=(a!==undefined)?a:{};delete this.data.length};var _nextEdgeId=-1;var Particle=function(a,b){this.p=a;this.m=b;this.v=new Point(0,0);this.f=new Point(0,0)};Particle.prototype.applyForce=function(a){this.f=this.f.add(a.divide(this.m))};var Spring=function(c,b,d,a){this.point1=c;this.point2=b;this.length=d;this.k=a};Spring.prototype.distanceToParticle=function(a){var c=that.point2.p.subtract(that.point1.p).normalize().normal();var b=a.p.subtract(that.point1.p);return Math.abs(b.x*c.x+b.y*c.y)};var Point=function(a,b){if(a&&a.hasOwnProperty("y")){b=a.y;a=a.x}this.x=a;this.y=b};Point.random=function(a){a=(a!==undefined)?a:5;return new Point(2*a*(Math.random()-0.5),2*a*(Math.random()-0.5))};Point.prototype={exploded:function(){return(isNaN(this.x)||isNaN(this.y))},add:function(a){return new Point(this.x+a.x,this.y+a.y)},subtract:function(a){return new Point(this.x-a.x,this.y-a.y)},multiply:function(a){return new Point(this.x*a,this.y*a)},divide:function(a){return new Point(this.x/a,this.y/a)},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normal:function(){return new Point(-this.y,this.x)},normalize:function(){return this.divide(this.magnitude())}};
  /*   system.js */  var ParticleSystem=function(d,p,e,f,s,l){var j=[];var h=null;var k=0;var t=null;var m=0.04;var i=[20,20,20,20];var n=null;var o=null;if(typeof p=="object"){var r=p;e=r.friction;d=r.repulsion;s=r.fps;l=r.dt;p=r.stiffness;f=r.gravity}e=isNaN(e)?0.5:e;d=isNaN(d)?1000:d;s=isNaN(s)?55:s;p=isNaN(p)?600:p;l=isNaN(l)?0.02:l;f=(f===true);var q=(s!==undefined)?1000/s:1000/50;var b={repulsion:d,stiffness:p,friction:e,dt:l,gravity:f,timeout:q};var a;var c={renderer:null,tween:null,nodes:{},edges:{},adjacency:{},names:{},kernel:null};var g={parameters:function(u){if(u!==undefined){$.each(b,function(x,w){if(u[x]!==undefined){b[x]=u[x]}});c.kernel.physicsModified(b)}return b},fps:function(u){if(u===undefined){return c.kernel.fps()}else{g.parameters({timeout:1000/(u||50)})}},start:function(){c.kernel.start()},stop:function(){c.kernel.stop()},addNode:function(u,w){w=w||{};var x=c.names[u];if(x){x.data=w;return x}else{if(u!=undefined){var v=new Node(w);v.name=u;c.names[u]=v;c.nodes[v._id]=v;j.push({t:"addNode",id:v._id,m:v.mass});g._notify();return v}}},pruneNode:function(v){var u=g.getNode(v);if(typeof(c.nodes[u._id])!=="undefined"){delete c.nodes[u._id];delete c.names[u.name]}$.each(c.edges,function(x,w){if(w.source._id===u._id||w.target._id===u._id){g.pruneEdge(w)}});j.push({t:"dropNode",id:u._id});g._notify()},getNode:function(u){if(u._id!==undefined){return u}else{if(typeof u=="string"||typeof u=="number"){return c.names[u]}}},eachNode:function(u){$.each(c.nodes,function(x,w){if(w._p.x==null||w._p.y==null){return}var v=(t!==null)?g.toScreen(w._p):w._p;u.call(g,w,v)})},addEdge:function(y,z,x){y=g.getNode(y)||g.addNode(y);z=g.getNode(z)||g.addNode(z);x=x||{};var w=new Edge(y,z,x);var A=y._id;var B=z._id;c.adjacency[A]=c.adjacency[A]||{};c.adjacency[A][B]=c.adjacency[A][B]||[];var v=(c.adjacency[A][B].length>0);if(v){$.extend(c.adjacency[A][B].data,w.data);return}else{c.edges[w._id]=w;c.adjacency[A][B].push(w);var u=(w.length!==undefined)?w.length:1;j.push({t:"addSpring",id:w._id,fm:A,to:B,l:u});g._notify()}return w},pruneEdge:function(z){j.push({t:"dropSpring",id:z._id});delete c.edges[z._id];for(var u in c.adjacency){for(var A in c.adjacency[u]){var v=c.adjacency[u][A];for(var w=v.length-1;w>=0;w--){if(c.adjacency[u][A][w]._id===z._id){c.adjacency[u][A].splice(w,1)}}}}g._notify()},getEdges:function(v,u){v=g.getNode(v);u=g.getNode(u);if(!v||!u){return[]}if(typeof(c.adjacency[v._id])!=="undefined"&&typeof(c.adjacency[v._id][u._id])!=="undefined"){return c.adjacency[v._id][u._id]}return[]},getEdgesFrom:function(u){u=g.getNode(u);if(!u){return[]}if(typeof(c.adjacency[u._id])!=="undefined"){var v=[];$.each(c.adjacency[u._id],function(x,w){v=v.concat(w)});return v}return[]},getEdgesTo:function(u){u=g.getNode(u);if(!u){return[]}var v=[];$.each(c.edges,function(x,w){if(w.target==u){v.push(w)}});return v},eachEdge:function(u){$.each(c.edges,function(y,w){var x=c.nodes[w.source._id]._p;var v=c.nodes[w.target._id]._p;if(x.x==null||v.x==null){return}x=(t!==null)?g.toScreen(x):x;v=(t!==null)?g.toScreen(v):v;if(x&&v){u.call(g,w,x,v)}})},prune:function(v){var u={dropped:{nodes:[],edges:[]}};if(v===undefined){$.each(c.nodes,function(x,w){u.dropped.nodes.push(w);g.pruneNode(w)})}else{g.eachNode(function(x){var w=v.call(g,x,{from:g.getEdgesFrom(x),to:g.getEdgesTo(x)});if(w){u.dropped.nodes.push(x);g.pruneNode(x)}})}return u},graft:function(v){var u={added:{nodes:[],edges:[]}};if(v.nodes){$.each(v.nodes,function(x,w){var y=g.getNode(x);if(y){y.data=w}else{u.added.nodes.push(g.addNode(x,w))}c.kernel.start()})}if(v.edges){$.each(v.edges,function(y,w){var x=g.getNode(y);if(!x){u.added.nodes.push(g.addNode(y,{}))}$.each(w,function(C,z){var B=g.getNode(C);if(!B){u.added.nodes.push(g.addNode(C,{}))}var A=g.getEdges(y,C);if(A.length>0){A[0].data=z}else{u.added.edges.push(g.addEdge(y,C,z))}})})}return u},merge:function(v){var u={added:{nodes:[],edges:[]},dropped:{nodes:[],edges:[]}};$.each(c.edges,function(z,y){if((v.edges[y.source.name]===undefined||v.edges[y.source.name][y.target.name]===undefined)){g.pruneEdge(y);u.dropped.edges.push(y)}});var x=g.prune(function(z,y){if(v.nodes[z.name]===undefined){u.dropped.nodes.push(z);return true}});var w=g.graft(v);u.added.nodes=u.added.nodes.concat(w.added.nodes);u.added.edges=u.added.edges.concat(w.added.edges);u.dropped.nodes=u.dropped.nodes.concat(x.dropped.nodes);u.dropped.edges=u.dropped.edges.concat(x.dropped.edges);return u},tweenNode:function(x,u,w){var v=g.getNode(x);if(v){c.tween.to(v,u,w)}},tweenEdge:function(v,u,y,x){if(x===undefined){g._tweenEdge(v,u,y)}else{var w=g.getEdges(v,u);$.each(w,function(z,A){g._tweenEdge(A,y,x)})}},_tweenEdge:function(v,u,w){if(v&&v._id!==undefined){c.tween.to(v,u,w)}},_updateGeometry:function(x){if(x!=undefined){var u=(x.epoch<k);a=x.energy;var y=x.geometry;if(y!==undefined){for(var w=0,v=y.length/3;w<v;w++){var z=y[3*w];if(u&&c.nodes[z]==undefined){continue}c.nodes[z]._p.x=y[3*w+1];c.nodes[z]._p.y=y[3*w+2]}}}},screen:function(u){if(u.size!==undefined){g.screenSize(u.size.width,u.size.height)}if(!isNaN(u.step)){g.screenStep(u.step)}if(u.padding!==undefined){g.screenPadding(u.padding)}},screenSize:function(u,v){t={width:u,height:v};g._updateBounds()},screenPadding:function(x,y,u,v){if($.isArray(x)){trbl=x}else{trbl=[x,y,u,v]}var z=trbl[0];var w=trbl[1];var A=trbl[2];if(w===undefined){trbl=[z,z,z,z]}else{if(A==undefined){trbl=[z,w,z,w]}}i=trbl},screenStep:function(u){m=u},toScreen:function(w){if(!n||!t){return}var v=i||[0,0,0,0];var u=n.bottomright.subtract(n.topleft);var y=v[3]+w.subtract(n.topleft).divide(u.x).x*(t.width-(v[1]+v[3]));var x=v[0]+w.subtract(n.topleft).divide(u.y).y*(t.height-(v[0]+v[2]));return arbor.Point(y,x)},fromScreen:function(y){if(!n||!t){return}var x=i||[0,0,0,0];var w=n.bottomright.subtract(n.topleft);var v=(y.x-x[3])/(t.width-(x[1]+x[3]))*w.x+n.topleft.x;var u=(y.y-x[0])/(t.height-(x[0]+x[2]))*w.y+n.topleft.y;return arbor.Point(v,u)},_updateBounds:function(v){if(t===null){return}if(v){o=v}else{o=g.bounds()}var y=new Point(o.bottomright.x,o.bottomright.y);var x=new Point(o.topleft.x,o.topleft.y);var A=y.subtract(x);var u=x.add(A.divide(2));var w=4;var C=new Point(Math.max(A.x,w),Math.max(A.y,w));o.topleft=u.subtract(C.divide(2));o.bottomright=u.add(C.divide(2));if(!n){if($.isEmptyObject(c.nodes)){return false}n=o;return true}var B=m;_newBounds={bottomright:n.bottomright.add(o.bottomright.subtract(n.bottomright).multiply(B)),topleft:n.topleft.add(o.topleft.subtract(n.topleft).multiply(B))};var z=new Point(n.topleft.subtract(_newBounds.topleft).magnitude(),n.bottomright.subtract(_newBounds.bottomright).magnitude());if(z.x*t.width>1||z.y*t.height>1){n=_newBounds;return true}else{return false}},energy:function(){return a},bounds:function(){var v=null;var u=null;$.each(c.nodes,function(y,x){if(!v){v=new Point(x._p);u=new Point(x._p);return}var w=x._p;if(w.x===null||w.y===null){return}if(w.x>v.x){v.x=w.x}if(w.y>v.y){v.y=w.y}if(w.x<u.x){u.x=w.x}if(w.y<u.y){u.y=w.y}});if(v&&u){return{bottomright:v,topleft:u}}else{return{topleft:new Point(-1,-1),bottomright:new Point(1,1)}}},nearest:function(w){if(t!==null){w=g.fromScreen(w)}var v={node:null,point:null,distance:null};var u=g;$.each(c.nodes,function(A,x){var y=x._p;if(y.x===null||y.y===null){return}var z=y.subtract(w).magnitude();if(v.distance===null||z<v.distance){v={node:x,point:y,distance:z};if(t!==null){v.screenPoint=g.toScreen(y)}}});if(v.node){if(t!==null){v.distance=g.toScreen(v.node.p).subtract(g.toScreen(w)).magnitude()}return v}else{return null}},_notify:function(){if(h===null){k++}else{clearTimeout(h)}h=setTimeout(g._synchronize,20)},_synchronize:function(){if(j.length>0){c.kernel.graphChanged(j);j=[];h=null}},};c.kernel=Kernel(g);c.tween=c.kernel.tween||null;Node.prototype.__defineGetter__("p",function(){var v=this;var u={};u.__defineGetter__("x",function(){return v._p.x});u.__defineSetter__("x",function(w){c.kernel.particleModified(v._id,{x:w})});u.__defineGetter__("y",function(){return v._p.y});u.__defineSetter__("y",function(w){c.kernel.particleModified(v._id,{y:w})});u.__proto__=Point.prototype;return u});Node.prototype.__defineSetter__("p",function(u){this._p.x=u.x;this._p.y=u.y;c.kernel.particleModified(this._id,{x:u.x,y:u.y})});Node.prototype.__defineGetter__("mass",function(){return this._mass});Node.prototype.__defineSetter__("mass",function(u){this._mass=u;c.kernel.particleModified(this._id,{m:u})});Node.prototype.__defineSetter__("tempMass",function(u){c.kernel.particleModified(this._id,{_m:u})});Node.prototype.__defineGetter__("fixed",function(){return this._fixed});Node.prototype.__defineSetter__("fixed",function(u){this._fixed=u;c.kernel.particleModified(this._id,{f:u?1:0})});return g};
  /*  physics.js */  var Physics=function(a,l,m,e,g){var c={particles:{},springs:{}};var k={particles:{}};var n=[];var j=[];var d=0;var b={sum:0,max:0,mean:0};var f={topleft:new Point(-1,-1),bottomright:new Point(1,1)};var i=1000;var h={stiffness:(l!==undefined)?l:1000,repulsion:(m!==undefined)?m:600,friction:(e!==undefined)?e:0.3,gravity:false,dt:(a!==undefined)?a:0.02,init:function(){return h},modifyPhysics:function(o){$.each(["stiffness","repulsion","friction","gravity","dt"],function(r,s){if(o[s]!==undefined){h[s]=o[s];if(s=="stiffness"){var q=o[s];$.each(c.springs,function(t,p){p.k=q})}}})},addNode:function(t){var s=t.id;var o=t.m;var r=t.p;if(r!==undefined&&c.particles[r]&&c.particles[r].p){var q=c.particles[r].p;c.particles[s]=new Particle(_nearParticle(q),o);c.particles[s].connections=0;n.push(c.particles[s]);k.particles[s]=c.particles[s]}else{var p=new Point(-3+3*Math.random(),-3+3*Math.random());c.particles[s]=new Particle(p,o);c.particles[s].connections=0;k.particles[s]=c.particles[s];n.push(c.particles[s])}},dropNode:function(r){var q=r.id;var p=c.particles[q];var o=$.inArray(p,n);if(o>-1){n.splice(o,1)}delete c.particles[q];delete k.particles[q]},modifyNode:function(q,o){if(q in c.particles){var p=c.particles[q];if("x" in o){p.p.x=o.x}if("y" in o){p.p.y=o.y}if("m" in o){p.m=o.m}if("f" in o){p.fixed=(o.f===1)}if("_m" in o){if(p._m===undefined){p._m=p.m}p.m=o._m}}},addSpring:function(s){var r=s.id;var o=s.l;var q=c.particles[s.fm];var p=c.particles[s.to];if(q!==undefined&&p!==undefined){c.springs[r]=new Spring(q,p,o,h.stiffness);j.push(c.springs[r]);q.connections++;p.connections++;delete k.particles[s.fm];delete k.particles[s.to]}},dropSpring:function(r){var q=r.id;var p=c.springs[q];p.point1.connections--;p.point2.connections--;var o=$.inArray(p,j);if(o>-1){j.splice(o,1)}delete c.springs[q]},_update:function(o){d++;$.each(o,function(p,q){if(q.t in h){h[q.t](q)}});return d},tick:function(){h.tendParticles();h.eulerIntegrator(h.dt);h.tock()},tock:function(){var o=[];$.each(c.particles,function(q,p){o.push(q);o.push(p.p.x);o.push(p.p.y)});if(g){g({geometry:o,epoch:d,energy:b,bounds:f})}},tendParticles:function(){$.each(c.particles,function(p,o){if(o._m!==undefined){if(Math.abs(o.m-o._m)<1){o.m=o._m;delete o._m}else{o.m*=0.98}}o.v.x=o.v.y=0})},eulerIntegrator:function(o){h.applyRepulsion();h.applySprings();h.applyCenterDrift();if(h.gravity){h.applyCenterGravity()}h.updateVelocity(o);h.updatePosition(o)},applyRepulsion:function(){$.each(c.particles,function(p,o){$.each(c.particles,function(r,q){if(o!==q){var t=o.p.subtract(q.p);var u=Math.max(1,t.magnitude());var s=((t.magnitude()>0)?t:Point.random(1)).normalize();o.applyForce(s.multiply(h.repulsion*(q._m||q.m)*0.5).divide(u*u*0.5));q.applyForce(s.multiply(h.repulsion*(o._m||o.m)*0.5).divide(u*u*-0.5))}})})},applySprings:function(){$.each(c.springs,function(s,o){var r=o.point2.p.subtract(o.point1.p);var p=o.length-r.magnitude();var q=((r.magnitude()>0)?r:Point.random(1)).normalize();o.point1.applyForce(q.multiply(o.k*p*-0.5));o.point2.applyForce(q.multiply(o.k*p*0.5))})},applyCenterDrift:function(){var p=0;var q=new Point(0,0);$.each(c.particles,function(s,r){q.add(r.p);p++});if(p==0){return}var o=q.divide(-p);$.each(c.particles,function(s,r){r.applyForce(o)})},applyCenterGravity:function(){$.each(c.particles,function(q,o){var p=o.p.multiply(-1);o.applyForce(p.multiply(h.repulsion/100))})},updateVelocity:function(o){$.each(c.particles,function(s,p){if(p.fixed){p.v=new Point(0,0);p.f=new Point(0,0);return}var r=p.v.magnitude();p.v=p.v.add(p.f.multiply(o)).multiply(1-h.friction);p.f.x=p.f.y=0;var q=p.v.magnitude();if(q>i){p.v=p.v.divide(q*q)}})},updatePosition:function(p){var q=0,o=0,t=0;var s=null;var r=null;$.each(c.particles,function(v,u){u.p=u.p.add(u.v.multiply(p));var w=u.v.magnitude();var y=w*w;q+=y;o=Math.max(y,o);t++;if(!s){s=new Point(u.p.x,u.p.y);r=new Point(u.p.x,u.p.y);return}var x=u.p;if(x.x===null||x.y===null){return}if(x.x>s.x){s.x=x.x}if(x.y>s.y){s.y=x.y}if(x.x<r.x){r.x=x.x}if(x.y<r.y){r.y=x.y}});b={sum:q,max:o,mean:q/t,n:t};f={topleft:r||new Point(-1,-1),bottomright:s||new Point(1,1)}},systemEnergy:function(o){return b}};return h.init()};var _nearParticle=function(b,c){var c=c||0;var a=b.x;var f=b.y;var e=c*2;return new Point(a-c+Math.random()*e,f-c+Math.random()*e)};

  // if called as a worker thread, set up a run loop for the Physics object and bail out
  if (typeof(window)=='undefined') return (function(){
  /* hermetic.js */  $={each:function(d,e){if($.isArray(d)){for(var c=0,b=d.length;c<b;c++){e(c,d[c])}}else{for(var a in d){e(a,d[a])}}},map:function(a,c){var b=[];$.each(a,function(f,e){var d=c(e);if(d!==undefined){b.push(d)}});return b},extend:function(c,b){if(typeof b!="object"){return c}for(var a in b){if(b.hasOwnProperty(a)){c[a]=b[a]}}return c},isArray:function(a){if(!a){return false}return(a.constructor.toString().indexOf("Array")!=-1)},inArray:function(c,a){for(var d=0,b=a.length;d<b;d++){if(a[d]===c){return d}}return -1},isEmptyObject:function(a){if(typeof a!=="object"){return false}var b=true;$.each(a,function(c,d){b=false});return b},};
  /*   worker.js */  var PhysicsWorker=function(){var b=20;var a=null;var d=null;var c=null;var g=[];var f=new Date().valueOf();var e={init:function(h){e.timeout(h.timeout);a=Physics(h.dt,h.stiffness,h.repulsion,h.friction,e.tock);return e},timeout:function(h){if(h!=b){b=h;if(d!==null){e.stop();e.go()}}},go:function(){if(d!==null){return}c=null;d=setInterval(e.tick,b)},stop:function(){if(d===null){return}clearInterval(d);d=null},tick:function(){a.tick();var h=a.systemEnergy();if(h.max<0.01){if(c===null){c=new Date().valueOf()}if(new Date().valueOf()-c>1000){e.stop()}else{}}else{c=null}},tock:function(h){h.type="geometry";postMessage(h)},modifyNode:function(i,h){a.modifyNode(i,h);e.go()},modifyPhysics:function(h){a.modifyPhysics(h)},update:function(h){var i=a._update(h)}};return e};var physics=PhysicsWorker();onmessage=function(a){if(!a.data.type){postMessage("¿kérnèl?");return}if(a.data.type=="physics"){var b=a.data.physics;physics.init(a.data.physics);return}switch(a.data.type){case"modify":physics.modifyNode(a.data.id,a.data.mods);break;case"changes":physics.update(a.data.changes);physics.go();break;case"start":physics.go();break;case"stop":physics.stop();break;case"sys":var b=a.data.param||{};if(!isNaN(b.timeout)){physics.timeout(b.timeout)}physics.modifyPhysics(b);physics.go();break}};
  })()


  arbor = (typeof(arbor)!=='undefined') ? arbor : {}
  $.extend(arbor, {
    // object constructors (don't use ‘new’, just call them)
    ParticleSystem:ParticleSystem,
    Point:function(x, y){ return new Point(x, y) },

    // immutable object with useful methods
    etc:{      
      trace:trace,              // ƒ(msg) -> safe console logging
      dirname:dirname,          // ƒ(path) -> leading part of path
      basename:basename,        // ƒ(path) -> trailing part of path
      ordinalize:ordinalize,    // ƒ(num) -> abbrev integers (and add commas)
      objcopy:objcopy,          // ƒ(old) -> clone an object
      objcmp:objcmp,            // ƒ(a, b, strict_ordering) -> t/f comparison
      objkeys:objkeys,          // ƒ(obj) -> array of all keys in obj
      objmerge:objmerge,        // ƒ(dst, src) -> like $.extend but non-destructive
      uniq:uniq,                // ƒ(arr) -> array of unique items in arr
      arbor_path:arbor_path,    // ƒ() -> guess the directory of the lib code
    }
  })
  
})(this.jQuery)